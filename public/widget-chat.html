<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="1">
    <title>Title</title>
</head>
<body>



<div id="widget-chat">
    <div class="form-group">
        <label class="control-label col-sm-2" for="mensaje">Mensaje:</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" name="mensaje"
                   placeholder="Escribe un mensaje..." id="mensaje" />
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10">
            <button type="button" class="btn btn-primary" id="boton-agregar"
                    onclick="enviarMensaje()">Enviar mensaje</button>
        </div>
    </div>
</div>

<div id=tablaMensaje>


</div>


</body>
</html>

<script>

    function enviarMensaje( ) {
        $.ajax({
            url: URLbase + "/oferta/mensaje/"+idOfertaSeleccionada,
            type: "POST",
            data: {
                mensaje : $("#mensaje").val()
            },
            dataType: 'json',
            success: function(respuesta){
                console.log(respuesta.token);  // <- Prueba
                token = respuesta.token;
                $("#contenedor-principal").load("widget-ofertas.html");
            },
            error : function (eror) {
                $( "#contenedor-principal" ).load("widget-login.html");
            }
        });

    }

    var mensajes;
    function cargarMensajes() {
        $.ajax({
            url: URLbase + "/conversacion",
            type: "GET",
            data: {},
            dataType: 'json',
            headers: {"token": token},
            success: function (respuesta) {
                mensajes = respuesta;
                actualizarTabla(mensajes);
            },
            error: function (error) {
                $("#contenedor-principal").load("widget-login.html");
            }
        });
    }

        function actualizarTabla(mensajeMostrar) {
            console.log(mensajeMostrar);
            $("#tablaMensaje").empty(); // Vaciar la tabla
            for (i = 0; i < mensajeMostrar.length; i++) {
                if (mensajeMostrar[i].emisor == Cookies.get('usuarioEnSesion')) {
                    $("#tablaMensaje").load(
                        " <div style='text-align:right'>" +

                            "<H3>" + mensajeMostrar[i].emisor + "</H3>" +
                        " <p>" + mensajeMostrar[i].mensaje + "</p>" +
                        "  <span style='text-align:right'>" + mensajeMostrar[i].fecha + "</span>" +
                        " </div>"
                    )


                } else {
                    $("#tablaMensaje").load(
                        " <div style='text-align:left'>" +
                        "<H3>" + mensajeMostrar[i].receptor + "</H3>" +
                        " <p>" + mensajeMostrar[i].mensaje + "</p>" +
                        "  <span style='text-align:right'>" + mensajeMostrar[i].fecha + "</span>" +
                        " </div>"
                    );
                }
            }
        }

        $(document).ready(function () {
            setTimeout(cargarMensajes, 1000);
        });

</script>